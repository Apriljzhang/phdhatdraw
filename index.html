<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>教育學博士進階研究方法課程</title>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background: linear-gradient(45deg, #ff6b6b, #4ecdc4); display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        h1 { font-size: 2em; margin-bottom: 10px; }
        select, input, button { font-size: 1.5em; padding: 10px; margin: 5px; }
        #classSelect { width: 200px; }
        #drawBtn { background: #ffd93d; color: #333; border: none; border-radius: 30px; cursor: pointer; }
        #drawBtn:disabled { background: #ccc; cursor: not-allowed; }
        #result { font-size: 3.5em; font-weight: bold; margin: 20px 0; min-height: 100px; display: flex; align-items: center; justify-content: center; opacity: 0; transform: scale(0.5); transition: all 0.5s; }
        #result.show { opacity: 1; transform: scale(1); }
        #status { font-size: 1.2em; margin: 10px 0; }
        #resultsTable { margin-top: 20px; width: 90%; background: rgba(255,255,255,0.2); border-radius: 15px; padding: 15px; max-height: 300px; overflow-y: auto; }
        #resultsTable table { width: 100%; border-collapse: collapse; }
        #resultsTable th, #resultsTable td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.3); }
        #resultsTable th { background: rgba(0,0,0,0.3); }
        #teacherPanel { margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 15px; display: none; }
        #showTeacher { font-size: 0.9em; color: #ffd93d; text-decoration: underline; cursor: pointer; }
        .note { font-size: 1.1em; color: #ffff99; margin: 5px 0; }
        #syncStatus { font-size: 0.9em; color: #aaffaa; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>教育學博士進階研究方法課程 - 小組抽題</h1>
    <select id="classSelect">
        <option value="">選擇班級</option>
        <option value="A">A班</option>
        <option value="B">B班</option>
        <option value="C">C班</option>
    </select>
    <div id="inputBox" style="display:none;">
        <div class="note">請輸入所有組員姓名（用逗號分隔）</div>
        <input type="text" id="groupName" placeholder="例如：張三,李四,王五">
        <button id="setGroup">確認小組</button>
    </div>
    <button id="drawBtn" disabled>抽一個！</button>
    <div id="result"></div>
    <div id="status"></div>
    <div id="syncStatus">連線中...</div>
    <div id="resultsTable">
        <strong>已抽取結果：</strong>
        <table id="resultsBody">
            <tr><th>組員姓名</th><th>抽到題目</th></tr>
        </table>
    </div>
    <div id="showTeacher">教師專用</div>
    <div id="teacherPanel">
        <input type="password" id="teacherPass" placeholder="密碼">
        <button id="loginTeacher">登入</button>
        <button id="resetAll" style="display:none;background:#ff4444;">重置全部</button>
        <button id="logoutTeacher" style="display:none;">登出</button>
    </div>

    <script>
        const FIREBASE_CONFIG = {
          apiKey: "AIzaSyDOIjX2aa6DoBp91Gwyhxfz3wjxUTPNhZU",
          authDomain: "phdhatdraw.firebaseapp.com",
          databaseURL: "https://phdhatdraw-default-rtdb.firebaseio.com",
          projectId: "phdhatdraw",
          storageBucket: "phdhatdraw.firebasestorage.app",
          messagingSenderId: "20504222006",
          appId: "1:20504222006:web:da471a770a8bd739f4bb97",
          measurementId: "G-0D02145JJV"
        };

        const allItems = [
            "研究問題", "文獻综述", "參考文獻管理軟體", "焦點小组訪談", "個別訪談",
            "課堂觀察", "問卷", "抽樣方法與樣本數", "準實驗研究設計", "個案研究設計",
            "主題分析", "內容分析", "敘事分析", "紮根理論編碼", "量化變數的類型",
            "t 檢定", "方差分析（ANOVA）", "皮爾森相關（Pearson correlation）",
            "線性迴歸（Linear regression）", "卡方檢定（Chi-Square Test）",
            "曼-惠特尼 U 檢定（Mann-Whitney U test）", "EFA/CFA", "中文APA", "倫理申请", "研究計畫書"
        ];

        let classId = '';
        let currentGroup = '';
        let available = [];
        let taken = {};
        let isTeacher = false;
        let db;

        const classSelect = document.getElementById('classSelect');
        const inputBox = document.getElementById('inputBox');
        const groupInput = document.getElementById('groupName');
        const setGroupBtn = document.getElementById('setGroup');
        const drawBtn = document.getElementById('drawBtn');
        const result = document.getElementById('result');
        const status = document.getElementById('status');
        const syncStatus = document.getElementById('syncStatus');
        const resultsBody = document.getElementById('resultsBody');
        const showTeacher = document.getElementById('showTeacher');
        const teacherPanel = document.getElementById('teacherPanel');
        const teacherPass = document.getElementById('teacherPass');
        const loginTeacher = document.getElementById('loginTeacher');
        const resetAll = document.getElementById('resetAll');
        const logoutTeacher = document.getElementById('logoutTeacher');

        function initFirebase() {
            const script = document.createElement('script');
            script.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js';
            script.onload = () => loadDatabase();
            document.head.appendChild(script);
        }

        function loadDatabase() {
            const dbScript = document.createElement('script');
            dbScript.src = 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js';
            dbScript.onload = () => {
                firebase.initializeApp(FIREBASE_CONFIG);
                db = firebase.database();
                syncStatus.textContent = '已連線！';
                loadData();
                startSync();
            };
            document.head.appendChild(dbScript);
        }

        function loadData() {
            db.ref('available').once('value').then(s => available = s.val() || [...allItems]);
            db.ref('taken').once('value').then(s => { taken = s.val() || {}; updateTable(); });
        }

        function startSync() {
            db.ref('taken').on('value', s => { taken = s.val() || {}; updateTable(); });
            db.ref('available').on('value', s => { available = s.val() || []; });
        }

        function save() {
            db.ref('available').set(available);
            db.ref('taken').set(taken);
        }

        function updateTable() {
            resultsBody.innerHTML = '<tr><th>組員姓名</th><th>抽到題目</th></tr>';
            Object.entries(taken).forEach(([g, t]) => {
                resultsBody.innerHTML += `<tr><td>${g}</td><td>${t}</td></tr>`;
            });
            if (!Object.keys(taken).length) resultsBody.innerHTML += '<tr><td colspan="2">尚未抽取</td></tr>';
        }

        classSelect.onchange = () => {
            classId = classSelect.value;
            inputBox.style.display = classId ? 'block' : 'none';
            if (classId) status.textContent = `已選 ${classId} 班（剩餘 ${available.length} 題）`;
        };

        setGroupBtn.onclick = () => {
            currentGroup = groupInput.value.trim();
            if (!currentGroup) return alert('請輸入姓名');
            if (taken[currentGroup]) {
                status.textContent = `已抽：${taken[currentGroup]}`;
                drawBtn.disabled = true;
            } else {
                status.textContent = `${currentGroup} 準備抽題`;
                drawBtn.disabled = false;
            }
            groupInput.disabled = setGroupBtn.disabled = true;
        };

        drawBtn.onclick = () => {
            if (!currentGroup || !available.length) return;
            const i = Math.floor(Math.random() * available.length);
            const topic = available.splice(i, 1)[0];
            taken[currentGroup] = topic;
            save();
            result.textContent = topic;
            result.classList.add('show');
            status.textContent = `${currentGroup} 抽到：${topic}`;
            drawBtn.disabled = true;
        };

        showTeacher.onclick = () => { teacherPanel.style.display = 'block'; showTeacher.style.display = 'none'; };
        loginTeacher.onclick = () => {
            if (teacherPass.value === 'teacher123') {
                isTeacher = true;
                teacherPass.style.display = loginTeacher.style.display = 'none';
                resetAll.style.display = logoutTeacher.style.display = 'inline-block';
            } else alert('密碼錯誤');
        };
        resetAll.onclick = () => {
            if (confirm('重置全部？')) db.ref().set({ available: [...allItems], taken: {} });
        };
        logoutTeacher.onclick = () => location.reload();

        initFirebase();
    </script>
</body>
</html>